<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2">
  <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://imgcache.qq.com/qcloud/tcbjs/1.3.5/tcb.js"></script>
  <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
  <script>
    const AppID = 'wxb0bbb77bb501cf0b'
    const EnvID = 'weapp-ebfl5'
    const app = tcb.init({
      env: EnvID // 环境id
    })
    window.onload = async (e) => {
      const auth = app.auth();
      async function login() {
        // 1. 建议登录前先判断当前是否已经登录
        let loginState = await auth.getLoginState();
        if (!loginState) {
          // 2. 调用微信登录API
          // snsapi_base、snsapi_userinfo
          const provider = auth.weixinAuthProvider({
            appid: AppID, // 微信公众号的Appid
            scope: "snsapi_userinfo"
          })
          // signInWithRedirect方法不存在
          await provider.signIn();
          // {isAnonymous: false, credential: {accessToken,refreshToken}}
          loginState = await auth.getLoginState();
        }
        return loginState
      }
      let loginState = await login();
      console.log('loginState', loginState);
      let accessToken = loginState.credential.accessToken

      // 从库中取出用户信息，可使用帐号信息登录
      const db = app.database();
      if (loginState) {
        const res = await db.collection("user").where({
          nickName: "程序员LIYI"
        }).limit(1).get();
        if (res.data.length) {
          let user = res.data[0]
          auth.currentUser = user
          console.log('user', user);
        }
      }
      const user = auth.currentUser;
      console.log('user', user);

      // 测试实时数据
      const watcher = db.collection('message')
      .orderBy('_id', 'desc')
      .limit(10)
      .where({
        room: '100000'
      })
      .watch({
        onChange: function(snapshot) {
          if (snapshot.docs.length){
            let doc = snapshot.docs[0]
            console.log('doc', doc);
          }
          // console.log('docs\'s changed events', snapshot.docChanges)
          // console.log('query result snapshot after the event', snapshot.docs)
          // console.log('is init data', snapshot.type === 'init')
        },
        onError: function(err) {
          console.error('the watch closed because of error', err)
        }
      })
      await db.collection('message').add({
        data:{
          room:'100000',
          user:'web',
          text:'message'+Math.random()*1000
        }
      })

      // 获取临时链接
      const fileID = 'cloud://weapp-ebfl5.7765-weapp-ebfl5-1301675402/img.png'
      let fileRes = await app
        .getTempFileURL({
          fileList: [fileID]
        })
      let url = fileRes.fileList[0].tempFileURL
      console.log('url',url);
      $('#img1').attr('src', url)

      // 尝试下载（不在许可范围内），也可以用，拿到的是url
      let fileDownloadRes = await app
        .downloadFile({
          fileID
        })
      url = fileDownloadRes.tempFilePath
      console.log('download url',url);

      // 准备签名jssdk,不存在getJSSDKSignature方法
      // const jssdkRes = await tcb.getJSSDKSignature({
      //   url: `${document.location.origin}/`
      // })
      // wx.config({
      //   debug: true,
      //   appId: AppID, // 必填，公众号的唯一标识
      //   timestamp: jssdkRes.timestamp + '', // 必填，生成签名的时间戳
      //   nonceStr: jssdkRes.nonceStr, // 必填，生成签名的随机串
      //   signature: jssdkRes.signature,// 必填，签名
      //   jsApiList: ['chooseImage'] // 必填，需要使用的JS接口列表
      // })

      // 触发云函数执行add_message，需要在服务器端调用
      // let postUrl = `https://api.weixin.qq.com/tcb/invokecloudfunction?access_token=${accessToken}&env=${EnvID}&name=add_message`
      // let postRes = await $.post({
      //   url:postUrl
      // })
      // console.log('postRes',postRes);

    }
  </script>
</head>

<body>
  Hello Cloudbase
  <img id="img1" />
</body>

</html>